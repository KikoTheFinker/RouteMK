<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Route Trips</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/company/company-view-trip.css">
</head>
<body>

<main id="main">
    <div class="content">
        <h2>Trips for Route</h2>

        <p>
            <strong>Route:</strong>
            <span th:text="${routeSource.getName()}"></span> â†’
            <span th:text="${routeDestination.getName()}"></span>
        </p>

        <div th:if="${#lists.isEmpty(trips)}" class="alert alert-warning">
            No trips found for this route.
        </div>

        <table th:if="${not #lists.isEmpty(trips)}" class="table table-striped">
            <thead>
            <tr>
                <th>#</th>
                <th>Trip Date</th>
                <th>Stops</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="trip, iterStat : ${trips}">
                <td th:text="${iterStat.count}"></td>
                <td th:text="${trip.getDate()}"></td>
                <td>
                    <ul>
                        <li th:each="stop : ${tripStops}"
                            th:if="${stop.getTrip().getTripId() == trip.getTripId()}"
                            th:text="|${stop.getLocation().getName()} (ETA: ${stop.getStopTime()})|">
                        </li>
                    </ul>
                </td>
            </tr>
            </tbody>
        </table>

        <h2>Add a New Trip</h2>
        <div class="trip-container">
            <form id="trip-form" class="trip-box" method="POST" action="/trips/add">
                <input type="hidden" name="routeId" th:value="${routeId}">

                <div class="mb-3">
                    <label for="trip-time" class="form-label">Trip Date:</label>
                    <input type="date" id="trip-time" name="tripDate" class="form-control" required>
                </div>

                <div class="stop-group">
                    <label class="form-label">Start Location:</label>
                    <input type="text" class="form-control" th:value="${routeSource.getName()}" readonly>
                    <label class="form-label">ETA:</label>
                    <input type="time" name="eta[]" class="form-control" required>
                </div>

                <div id="stops-container"></div>

                <div class="stop-group">
                    <label class="form-label">End Location:</label>
                    <input type="text" class="form-control" th:value="${routeDestination.getName()}" readonly>
                    <label class="form-label">ETA:</label>
                    <input type="time" name="eta[]" class="form-control" required>
                </div>

                <button type="button" class="btn btn-outline-dark" id="add-stop">+ Add Stop</button>
                <button type="submit" id="trip-submit" class="btn btn-danger">Submit Trip</button>
            </form>
        </div>
    </div>
</main>

<select id="location-template" style="display:none;">
    <option th:each="location : ${locations}"
            th:value="${location.getId()}"
            th:text="${location.getName()}">
    </option>
</select>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const stopsContainer = document.getElementById("stops-container");
        const addStopBtn = document.getElementById("add-stop");
        const locationTemplate = document.getElementById("location-template");

        let selectedStops = new Set(); // Keep track of selected stops

        function getAvailableOptions() {
            let options = "";
            locationTemplate.querySelectorAll("option").forEach(option => {
                if (!selectedStops.has(option.value)) {
                    options += `<option value="${option.value}">${option.textContent}</option>`;
                }
            });
            return options;
        }

        function updateDropdowns() {
            document.querySelectorAll(".stop-select").forEach(select => {
                const currentValue = select.value;
                select.innerHTML = getAvailableOptions();
                if (currentValue) {
                    select.value = currentValue;
                }
            });
        }

        addStopBtn.addEventListener("click", function () {
            if (getAvailableOptions() === "") {
                alert("No more available stops!");
                return;
            }

            let stopGroup = document.createElement("div");
            stopGroup.classList.add("stop-group");

            stopGroup.innerHTML = `
                <label class="form-label">Stop Location:</label>
                <select name="stop_location[]" class="form-control stop-select" required>
                    ${getAvailableOptions()}
                </select>

                <label class="form-label">ETA:</label>
                <input type="time" name="eta[]" class="form-control" required>

                <button type="button" class="btn btn-danger remove-stop">Delete Stop</button>
            `;

            stopsContainer.appendChild(stopGroup);

            const selectElement = stopGroup.querySelector(".stop-select");

            selectElement.addEventListener("change", function () {
                const selectedId = this.value;
                if (selectedId) {
                    selectedStops.add(selectedId);
                }
                updateDropdowns();
            });

            stopGroup.querySelector(".remove-stop").addEventListener("click", function () {
                const select = stopGroup.querySelector(".stop-select");
                if (select) {
                    selectedStops.delete(select.value);
                }
                stopGroup.remove();
                updateDropdowns();
            });

            updateDropdowns();
        });
    });
</script>

</body>
</html>
