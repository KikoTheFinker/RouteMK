<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" th:href="@{/css/trip-route-filter-table.css}"/>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

    <style>
        .notification {
            margin: 20px;
            font-style: italic;
            color: #888;
        }

        .icon-arrow {
            color: white;
        }

        thead th {
            cursor: pointer;
        }

        input[type = "text"], label {
            display: inline;
        }

        #main {
            flex: 1;
            width: 50%;
            max-width: 1000px;
            margin: 2rem auto;
            padding: 1.5rem;
        }

        .date-filter {
            margin: 20px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .date-filter label {
            font-weight: bold;
        }

        #datepicker {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>

    <title>Routes</title>
</head>
<body>
<div id="main">
    <div class="title-container mt-5">
        <h1 class="badgify mb-1">
            <i class="bi bi-signpost-split me-2"></i>
            <span th:text="${routeSource}"></span>
            <i class="bi bi-arrow-right mx-2"></i>
            <span th:text="${routeDestination}"></span>
        </h1>

        <div>
            <form th:action="@{/favorites/change-favorites-status/{routeId}(routeId=${routeId}, remove=${isFavorite})}"
                  method="post" class="d-inline">
                <button type="submit"
                        class="btn btn-danger"
                        th:classappend="${isFavorite} ? ' active btn-danger text-white' : ''">
                    <i class="bi" th:classappend="${isFavorite} ? ' bi-heart-fill' : ' bi-heart'"></i>
                    <span class="ms-2"
                          th:text="${isFavorite} ? 'Remove from Favorites' : 'Add to Favorites'"></span>
                </button>
            </form>
        </div>

    </div>

    <div th:if="${trips != null and !trips.isEmpty()}">
        <div class="date-filter">
            <label for="datepicker">Filter by date:</label>
            <input type="text" id="datepicker" placeholder="Select date...">
            <button id="clearDate" class="btn-standard"><i class="bi bi-arrow-counterclockwise me-2"></i>Reset filters</button>
        </div>
    </div>


    <div th:if="${trips != null and !trips.isEmpty()}">
        <div class="routes-container">
            <div class="routes-table-wrapper">
                <table class="routes-table" id="routesTable">
                    <thead>
                    <tr>
                        <th>Departure <span class="icon-arrow">&UpArrow;</span></th>
                        <th>Stops <span class="icon-arrow">&UpArrow;</span></th>
                        <th>Available tickets <span class="icon-arrow">&UpArrow;</span></th>
                        <th>Lowest price <span class="icon-arrow">&UpArrow;</span></th>
                        <th>Purchase <span class="icon-arrow">&UpArrow;</span></th>
                    </tr>
                    </thead>
                    <tbody id="routes-list">
                    <!--                    TODO: implement purchasing through ticket creation-->
                    <tr th:each="trip : ${trips}" class="route-row">
                        <td th:text="${trip.getDate()}"
                            th:attr="data-date=${#temporals.format(trip.getDate(), 'yyyy-MM-dd')}"></td>
                        <td th:text="${stops[trip.getTripId()]}"></td>
                        <td th:text="${seatsLeftPerTrip[trip.getTripId()]}"></td>
                        <td th:text="${cheapestTicketPrice[trip.getTripId()]}"></td>
                        <td>
                            <a th:if="${seatsLeftPerTrip[trip.getTripId()] != 0}" th:href="@{/}" class="btn-redoutline"><i class="bi bi-credit-card me-2"></i>Purchase</a>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div th:if="${emptyMessage}">
        <p class="notification" th:text="${emptyMessage}"></p>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {

        const datepicker = flatpickr("#datepicker", {
            dateFormat: "Y-m-d",
            allowInput: true,
            onChange: function (selectedDates, dateStr) {
                filterByDate(dateStr);
            }
        });

        document.getElementById('clearDate').addEventListener('click', function () {
            datepicker.clear();
            filterByDate('');
        });

        function filterByDate(dateStr) {
            const rows = document.querySelectorAll('#routes-list tr.route-row');
            rows.forEach(row => {
                const dateCell = row.querySelector('td[data-date]');
                if (dateCell) {
                    const rowDate = dateCell.getAttribute('data-date');
                    if (dateStr === '' || rowDate === dateStr) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                }
            });
        }
    });
</script>

</body>
</html>