<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" th:href="@{/css/trip-route-filter-table.css}"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Golos+Text:wght@400;500;600&display=swap" rel="stylesheet">

    <style>
        .hidden { display: none !important; }

        .notification {
            margin: 20px;
            font-style: italic;
            color: #888;
        }

        .icon-arrow { color: white; }
        thead th { cursor: pointer; }
        input[type="text"], label { display: inline; }

        #main {
            flex: 1;
            width: 50%;
            max-width: 1000px;
            margin: 2rem auto;
            padding: 1.5rem;
        }

        .date-filter {
            margin: 20px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .date-filter label { font-weight: bold; }

        #datepicker {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: #fff;
            padding: 20px;
            width: 90%;
            max-width: 500px;
            border-radius: 5px;
            position: relative;
        }

        .modal-content h2 { margin-top: 0; }

        .close-modal {
            position: absolute;
            top: 10px;
            right: 15px;
            cursor: pointer;
            font-size: 20px;
            line-height: 1;
        }
    </style>

    <title>Routes</title>
</head>
<body>
<div id="main">
    <div class="title-container mt-5">
        <h1 class="badgify mb-1">
            <i class="bi bi-signpost-split me-2"></i>
            <span th:text="${routeSource}"></span>
            <i class="bi bi-arrow-right mx-2"></i>
            <span th:text="${routeDestination}"></span>
        </h1>

        <div>
            <form th:action="@{/favorites/change-favorites-status/{routeId}(routeId=${routeId}, remove=${isFavorite})}"
                  method="post" class="d-inline">
                <button type="submit" class="btn btn-danger"
                        th:classappend="${isFavorite} ? ' active btn-danger text-white' : ''">
                    <i class="bi" th:classappend="${isFavorite} ? ' bi-heart-fill' : ' bi-heart'"></i>
                    <span class="ms-2" th:text="${isFavorite} ? 'Remove from Favorites' : 'Add to Favorites'"></span>
                </button>
            </form>
        </div>
    </div>

    <div th:if="${trips != null and !trips.isEmpty()}">
        <div class="date-filter">
            <label for="datepicker">Filter by date:</label>
            <input type="text" id="datepicker" placeholder="Select date...">
            <button id="clearDate" class="btn-standard"><i class="bi bi-arrow-counterclockwise me-2"></i>Reset filters</button>
        </div>
    </div>

    <div th:if="${trips != null && !trips.isEmpty()}">
        <div class="routes-container">
            <div class="routes-table-wrapper">
                <table class="routes-table" id="routesTable">
                    <thead>
                    <tr>
                        <th>Departure <span class="icon-arrow">&UpArrow;</span></th>
                        <th>Stops <span class="icon-arrow">&UpArrow;</span></th>
                        <th>Available tickets <span class="icon-arrow">&UpArrow;</span></th>
                        <th>Lowest price <span class="icon-arrow">&UpArrow;</span></th>
                        <th>Purchase <span class="icon-arrow">&UpArrow;</span></th>
                    </tr>
                    </thead>
                    <tbody id="routes-list">
                    <tr th:each="trip : ${trips}" class="route-row">
                        <td th:with="depTime=${#lists.isEmpty(trip.stops) ? null : trip.stops.iterator().next().stopTime}"
                            th:attr="data-date=${#temporals.format(trip.date,'yyyy-MM-dd')},
                                     data-time=${depTime != null ? #temporals.format(depTime,'HH:mm') : ''}">
                            <span th:text="${#temporals.format(trip.date,'yyyy-MM-dd')}"></span>
                            <span th:if="${depTime != null}"> Â· </span>
                            <span th:if="${depTime != null}" th:text="${#temporals.format(depTime,'HH:mm')}"></span>
                        </td>
                        <td class="text-center">
                            <button type="button" class="btn-standard view-stops-btn">
                                <i class="bi bi-geo me-1"></i>View Stops
                            </button>
                            <div class="hidden-stops hidden" th:each="stop : ${trip.stops}">
                                <span class="stop-location" th:text="${stop.location.name}"></span>
                                <span class="stop-time" th:text="${#temporals.format(stop.stopTime,'HH:mm')}"></span>
                            </div>
                        </td>

                        <td th:text="${seatsLeftPerTrip[trip.getTripId()]}"></td>
                        <td th:with="price=${cheapestTicketPrice[trip.tripId]}, seats=${seatsLeftPerTrip[trip.tripId]}">
                            <span th:if="${price instanceof T(java.lang.Number) and seats > 0}">
                                $<span th:text="${#numbers.formatDecimal(price,1,2)}"></span>
                            </span>
                            <span th:unless="${price instanceof T(java.lang.Number) and seats > 0}"
                                  th:text="${price}"></span>
                        </td>
                        <td>
                            <a th:if="${seatsLeftPerTrip[trip.getTripId()] != 0}" th:href="@{/}" class="btn-redoutline">
                                <i class="bi bi-credit-card me-2"></i>Purchase
                            </a>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div th:if="${emptyMessage}">
        <p class="notification" th:text="${emptyMessage}"></p>
    </div>
</div>

<div id="stopsModal" class="modal hidden">
    <div class="modal-content wide">
        <span class="close-modal" id="closeStopsModal">&times;</span>
        <h2 class="modal-title">Trip Stops Overview</h2>
        <div id="stopsFlow" class="stops-flow"></div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const datepicker = flatpickr("#datepicker", {
            dateFormat: "Y-m-d",
            allowInput: true,
            onChange: function (selectedDates, dateStr) {
                filterByDate(dateStr);
            }
        });

        const clearBtn = document.getElementById('clearDate');
        if (clearBtn) {
            clearBtn.addEventListener('click', function () {
                datepicker.clear();
                filterByDate('');
            });
        }

        function filterByDate(dateStr) {
            const rows = document.querySelectorAll('#routes-list tr.route-row');
            rows.forEach(row => {
                const dateCell = row.querySelector('td[data-date]');
                if (!dateCell) return;
                const rowDate = dateCell.getAttribute('data-date');
                row.style.display = (dateStr === '' || rowDate === dateStr) ? '' : 'none';
            });
        }
    });
</script>
<script src="/js/stops-modal.js"></script>
</body>
</html>
