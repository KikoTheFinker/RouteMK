<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <title>My Reviews</title>
    <link rel="stylesheet" th:href="@{/css/ticket-display.css}"/>
    <link rel="stylesheet" th:href="@{/css/trip-route-filter-table.css}"/>
</head>
<body>
<div id="main">
    <div class="title-container mt-5">
        <h1 class="badgify theme-tickets"><i class="bi bi-ticket-perforated me-2"></i>My Reviews</h1>
    </div>

    <div class="tickets-filter-container">
        <div class="filter-heading mb-3 w-100 d-flex justify-content-between">
            <div>
                <i class="bi bi-funnel me-1"></i> <span>Filter</span>
            </div>
            <div class="d-flex justify-content-center align-items-center" style="align-self: end;">
                <button id="resetReviewFilters" class="btn-standard">Reset Filters</button>
            </div>
        </div>
        <div class="d-flex flex-row gap-2">
            <div class="filter-field">
                <label for="dateFrom" class="filter-label">Date From</label>
                <input type="date" id="dateFrom" class="form-control">
            </div>
            <div class="filter-field">
                <label for="dateTo" class="filter-label">Date To</label>
                <input type="date" id="dateTo" class="form-control">
            </div>
            <div class="filter-field">
                <label for="pickupFilter" class="filter-label">Pickup Location</label>
                <input type="text" id="pickupFilter" class="form-control" placeholder="ex. Struga">
            </div>
            <div class="filter-field">
                <label for="dropFilter" class="filter-label">Drop Location</label>
                <input type="text" id="dropFilter" class="form-control" placeholder="ex. Skopje">
            </div>
            <div class="filter-field">
                <label for="ratingFilter" class="filter-label">Rating</label>
                <select id="ratingFilter" class="form-control">
                    <option value="">Any Rating</option>
                    <option value="5">5 Stars</option>
                    <option value="4">4 Stars</option>
                    <option value="3">3 Stars</option>
                    <option value="2">2 Stars</option>
                    <option value="1">1 Star</option>
                </select>
            </div>
        </div>
    </div>

    <div class="tickets-list">
        <div th:each="review : ${reviews}" class="ticket-container"
             th:attr="data-date=${review.ticket.datePurchased}, data-rating=${review.rating}, data-pickup=${review.ticket.pickupLocation.name}, data-drop=${review.ticket.leavesAtLocation.name}">
            <div class="ticket-header">
                <div>
                    <i class="bi bi-hash me-1 text-danger"></i>
                    <span class="text-dark">Review ID: </span>
                    <span th:text="${review.reviewId}" style="text-shadow: 0 0 3px rgba(0,0,0,0.51)"></span>
                </div>
                <div>
                    <i class="bi bi-clock-history me-1 text-danger"></i>
                    <span th:text="${review.ticket.datePurchased} + ' ' + ${review.ticket.timePurchased}">Date & Time</span>
                </div>
            </div>
            <hr class="dotted-hr"/>
            <div class="ticket-body">
                <div class="ticket-info-block">
                    <span class="ticket-label"><i class="bi bi-signpost-split text-danger me-1"></i>Route travelled</span><br>
                    <span th:text="${review.ticket.trip.route.source.name} + ' â†’ ' + ${review.ticket.trip.route.destination.name}"></span>
                </div>
                <div class="ticket-info-block">
                    <span class="ticket-label"><i class="bi bi-star-fill me-1 text-danger"></i>Rating</span><br>
                    <div class="d-flex align-items-center">
                        <div th:each="i : ${#numbers.sequence(1, 5)}" class="me-1">
                            <i th:class="${i <= review.rating} ? 'bi bi-star-fill text-warning' : 'bi bi-star text-muted'"></i>
                        </div>
                        <span th:text="'(' + ${review.rating} + '/5)'" class="ms-2 text-muted"></span>
                    </div>
                </div>
                <div class="ticket-info-block">
                    <span class="ticket-label"><i class="bi bi-arrow-90deg-up me-1 text-danger"></i>Pickup Location</span><br>
                    <span th:text="${review.ticket.pickupLocation.name}"></span>
                </div>
                <div class="ticket-info-block">
                    <span class="ticket-label"><i class="bi bi-arrow-90deg-down me-1 text-danger"></i>Drop-off Location</span><br>
                    <span th:text="${review.ticket.leavesAtLocation.name}"></span>
                </div>
                <div class="ticket-info-block">
                    <span class="ticket-label">Seat:</span><br>
                    <span th:text="${review.ticket.seat}"></span>
                </div>
                <div class="ticket-info-block">
                    <span class="ticket-label"><i class="bi bi-ticket-perforated me-1 text-danger"></i>Ticket ID</span><br>
                    <span th:text="'#' + ${review.ticket.ticketId}"></span>
                </div>
            </div>

            <!-- Review Description Section -->
            <div th:if="${review.description != null and !review.description.isEmpty()}" class="mt-3">
                <hr class="dotted-hr"/>
                <div class="review-description">
                    <span class="ticket-label"><i class="bi bi-chat-quote me-1 text-danger"></i>My Review</span><br>
                    <div class="mt-2 p-3" style="background-color: #f8f9fa; border-radius: 8px; border-left: 4px solid #dc3545;">
                        <p th:text="${review.description}" class="mb-0" style="font-style: italic; color: #495057;"></p>
                    </div>
                </div>
            </div>
        </div>

        <div th:if="${reviews.isEmpty()}" id="noReviews" class="text-center mt-5">
            <div class="d-flex flex-column align-items-center">
                <i class="bi bi-star text-muted" style="font-size: 4rem;"></i>
                <h4 class="text-muted mt-3">No reviews found</h4>
                <p class="text-muted">You haven't written any reviews yet.</p>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const dateFromInput = document.getElementById('dateFrom');
        const dateToInput = document.getElementById('dateTo');
        const pickupFilterInput = document.getElementById('pickupFilter');
        const dropFilterInput = document.getElementById('dropFilter');
        const ratingFilterSelect = document.getElementById('ratingFilter');
        const resetButton = document.getElementById('resetReviewFilters');
        const reviewContainers = document.querySelectorAll('.ticket-container');
        const noReviewsDiv = document.getElementById('noReviews');

        function filterReviews() {
            const dateFrom = dateFromInput.value;
            const dateTo = dateToInput.value;
            const pickupFilter = pickupFilterInput.value.toLowerCase();
            const dropFilter = dropFilterInput.value.toLowerCase();
            const ratingFilter = ratingFilterSelect.value;

            let visibleCount = 0;

            reviewContainers.forEach(container => {
                const reviewDate = container.getAttribute('data-date');
                const reviewRating = container.getAttribute('data-rating');
                const pickupLocation = container.getAttribute('data-pickup').toLowerCase();
                const dropLocation = container.getAttribute('data-drop').toLowerCase();

                let isVisible = true;

                if (dateFrom && reviewDate < dateFrom) isVisible = false;
                if (dateTo && reviewDate > dateTo) isVisible = false;

                if (pickupFilter && !pickupLocation.includes(pickupFilter)) isVisible = false;
                if (dropFilter && !dropLocation.includes(dropFilter)) isVisible = false;

                if (ratingFilter && reviewRating !== ratingFilter) isVisible = false;

                container.style.display = isVisible ? 'block' : 'none';
                if (isVisible) visibleCount++;
            });

            if (noReviewsDiv) {
                noReviewsDiv.style.display = visibleCount === 0 ? 'block' : 'none';
            }
        }

        dateFromInput.addEventListener('change', filterReviews);
        dateToInput.addEventListener('change', filterReviews);
        pickupFilterInput.addEventListener('input', filterReviews);
        dropFilterInput.addEventListener('input', filterReviews);
        ratingFilterSelect.addEventListener('change', filterReviews);

        resetButton.addEventListener('click', function() {
            dateFromInput.value = '';
            dateToInput.value = '';
            pickupFilterInput.value = '';
            dropFilterInput.value = '';
            ratingFilterSelect.value = '';
            filterReviews();
        });
    });

</script>


</body>
</html>